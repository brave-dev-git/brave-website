---
const {
  heading = "Kontakt",
  text = "Hör av dig så tar vi ett kort, förutsättningslöst samtal. Beskriv gärna din roll och vad du vill få klarhet i.",
  endpoint,
  source = "",

  // Fallback-kontakt (visas bara om skickning misslyckas)
  email = "kontakt@bravesecurity.se",
  phoneDisplay = "+46 730 666 891",
  phoneTel = "+46730666891",
}: {
  heading?: string;
  text?: string;
  endpoint: string;
  source?: string;
  email?: string;
  phoneDisplay?: string;
  phoneTel?: string;
} = Astro.props;

// 2) Auto-source: om ingen source skickas in, använd aktuell path
const path = Astro.url?.pathname ?? "";
const effectiveSource = source || (path ? `page:${path}` : "");
---

<section class="section" aria-label="Kontakt" id="kontakt">
  <div class="section-surface">
    <header class="section-head">
      <h2 class="h2xl">{heading}</h2>
      <p class="muted">{text}</p>
    </header>

    <form class="form" method="POST" action={endpoint} data-contact-form>
      {effectiveSource ? (
        <input type="hidden" name="source" value={effectiveSource} />
      ) : null}

      <div class="grid2">
        <label class="field">
          <span class="label">Förnamn *</span>
          <input class="input" name="firstName" autocomplete="given-name" required />
        </label>

        <label class="field">
          <span class="label">Efternamn *</span>
          <input class="input" name="lastName" autocomplete="family-name" required />
        </label>

        <label class="field">
          <span class="label">Telefon</span>
          <input class="input" name="phone" autocomplete="tel" inputmode="tel" />
        </label>

        <label class="field">
          <span class="label">E-post *</span>
          <input class="input" type="email" name="email" autocomplete="email" required />
        </label>
      </div>

      <label class="field">
        <span class="label">Meddelande *</span>
        <textarea class="textarea" name="message" rows="6" required></textarea>
      </label>

        <label class="field">
        <span class="label">Hur hittade du oss?</span>
        <select class="input" name="foundVia">
            <option value="">Välj…</option>
            <option value="Rekommendation">Jag blev rekommenderad</option>
            <option value="Google">Jag sökte Google</option>
            <option value="AI">Jag sökte på en AI-tjänst</option>
            <option value="LinkedIn">Jag hittade er på LinkedIn</option>
            <option value="Annat">Annat</option>
        </select>
        </label>

      <label class="check consent">
        <!-- <input type="checkbox" name="consent" required />-->
         När du kontaktar oss behandlar vi dina personuppgifter för att kunna hantera din förfrågan.
         Uppgifterna används endast för detta ändamål.
 
      </label>

      <!-- Honeypot (spam). OBS: lämna tom -->
      <input class="hp" type="text" name="company_website" tabindex="-1" autocomplete="off" />

      <div class="cta-row">
        <button class="btn-primary" type="submit">Skicka</button>
        <a class="btn-secondary" href="/kontakt">Kontaktuppgifter</a>
      </div>

      <p class="form-status" aria-live="polite"></p>

      <!-- 3) Fallback visas endast vid fel -->
      <p class="form-fallback" hidden>
        Problem att skicka? Maila oss på
        <a class="link" href={`mailto:${email}`}>{email}</a>
        eller ring
        <a class="link" href={`tel:${phoneTel}`}>{phoneDisplay}</a>.
      </p>
    </form>
  </div>
</section>

<script is:inline>
  document.addEventListener("DOMContentLoaded", () => {
    const forms = document.querySelectorAll("[data-contact-form]");

    forms.forEach((form) => {
      const statusEl = form.querySelector(".form-status");
      const fallbackEl = form.querySelector(".form-fallback");
      const submitBtn = form.querySelector('button[type="submit"]');
      const honeypot = form.querySelector('input[name="company_website"]');

      form.addEventListener("submit", async (e) => {
        e.preventDefault();

        // 3) Honeypot: om den är ifylld -> gör inget
        if (honeypot && honeypot.value) return;

        // kör browserns validering först
        if (!form.checkValidity()) {
          form.reportValidity();
          return;
        }

        // 1) Disable submit (hindrar dubbelklick)
        if (submitBtn) submitBtn.disabled = true;

        if (statusEl) statusEl.textContent = "Skickar...";
        if (fallbackEl) fallbackEl.hidden = true;

        try {
          const data = new FormData(form);

          const res = await fetch(form.action, {
            method: "POST",
            body: data,
            headers: { Accept: "application/json" },
          });

          if (res.ok) {
            window.location.assign("/tack");
            return;
          }

          if (statusEl) statusEl.textContent = "Något gick fel. Försök igen eller maila oss.";
          if (fallbackEl) fallbackEl.hidden = false;
          if (submitBtn) submitBtn.disabled = false;
        } catch {
          if (statusEl) statusEl.textContent = "Något gick fel. Försök igen eller maila oss.";
          if (fallbackEl) fallbackEl.hidden = false;
          if (submitBtn) submitBtn.disabled = false;
        }
      });
    });
  });
</script>

<style>
  .form { max-width: 980px; }

  /* Viktigt för att grid-barn inte ska "spränga" layouten */
  .grid2 > * { min-width: 0; }

  .field { display: grid; gap: 0.45rem; margin-top: 1rem; }
  .label {
    color: rgba(229,231,235,0.85);
    font-size: 0.9rem;
    font-weight: 650;
  }

  .input, .textarea {
    width: 100%;
    box-sizing: border-box;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.28);
    background: rgba(2,6,23,0.28);
    color: var(--text);
    padding: 0.8rem 0.9rem;
    outline: none;
  }

  .textarea { resize: vertical; min-height: 140px; }

  .input:focus, .textarea:focus {
    border-color: rgba(231,111,81,0.6);
    box-shadow: 0 0 0 3px rgba(231,111,81,0.12);
  }

  /* Fieldset/legend: ta bort “fula ramar” */
  fieldset.field {
    border: 0;
    padding: 0;
    margin: 1.1rem 0 0;
    min-width: 0;
  }
  legend.label {
    padding: 0;
    margin-bottom: 0.45rem;
  }

  .checks {
    display: grid;
    gap: 0.65rem;
    margin-top: 0.35rem;
    padding: 0.75rem;
    border-radius: 14px;
    border: 1px solid rgba(148,163,184,0.18);
    background: rgba(2,6,23,0.18);
  }

  .check {
    display: inline-flex;
    gap: 0.7rem;
    align-items: flex-start;
    color: rgba(229,231,235,0.82);
    line-height: 1.35;
  }

  .check input { margin-top: 0.18rem; }

  .consent {
    margin-top: 1rem;
    padding-top: 0.9rem;
    border-top: 1px solid rgba(148,163,184,0.14);
  }

  .hp { display: none; }

  .form-status {
    margin-top: 0.85rem;
    color: rgba(229,231,235,0.75);
    font-size: 0.9rem;
  }

  .form-fallback {
    margin-top: 0.55rem;
    color: rgba(229,231,235,0.75);
    font-size: 0.9rem;
  }

  .btn-primary:disabled {
    opacity: 0.6;
    cursor: not-allowed;
    transform: none;
  }

  /* Mobil: gör grid till en kolumn */
  @media (max-width: 720px) {
    .grid2 { grid-template-columns: 1fr; }
  }

  /* ===== Compact mode (default) ===== */
.form { max-width: 880px; }            /* lite smalare */
.field { margin-top: 0.75rem; }        /* mindre luft mellan fält */
.label { font-size: 0.85rem; }         /* lite mindre label */

.input, .textarea {
  padding: 0.6rem 0.75rem;             /* tajtare inputs */
  border-radius: 12px;
}

.textarea {
  min-height: 110px;                   /* mindre än 140px */
}

.checks {
  padding: 0.6rem;                     /* tajtare box */
  gap: 0.5rem;
}

.check {
  gap: 0.55rem;                        /* tajtare mellan radio och text */
  line-height: 1.25;
}

.consent {
  margin-top: 0.75rem;
  padding-top: 0.7rem;
}

/* CTA-raden lite tajtare */
.cta-row { margin-top: 0.75rem; }

/* Mobil: lite extra tajt */
@media (max-width: 720px) {
  .field { margin-top: 0.65rem; }
  .textarea { min-height: 100px; }
}


</style>
